---
import Layout from '@layouts/Layout.astro';
---

<Layout title="Entrar" description="Fa莽a login na sua conta Ayronia">
  <div class="min-h-screen bg-base-200 flex items-center justify-center py-12 px-4">
    <div class="card bg-base-100 shadow-xl w-full max-w-md">
      <div class="card-body">
        <h1 class="card-title text-3xl justify-center mb-6">Entrar</h1>

        <form id="login-form" class="space-y-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text">Email</span>
            </label>
            <input
              type="email"
              id="email"
              placeholder="seu@email.com"
              class="input input-bordered"
              required
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Senha</span>
            </label>
            <input
              type="password"
              id="password"
              placeholder="A sua senha"
              class="input input-bordered"
              required
            />
            <label class="label">
              <a href="/esqueci-senha" class="label-text-alt link link-hover">Esqueceu a senha?</a>
            </label>
          </div>

          <div id="login-error" class="alert alert-error hidden">
            <span id="login-error-message"></span>
          </div>

          <button type="submit" class="btn btn-primary btn-block" id="login-btn">
            <span id="login-btn-text">Entrar</span>
            <span id="login-loading" class="loading loading-spinner hidden"></span>
          </button>
        </form>

        <!-- OTP Verification Section (for unverified accounts) -->
        <div id="verify-section" class="hidden space-y-4">
          <div class="text-center mb-4">
            <div class="text-5xl mb-4"></div>
            <h2 class="text-xl font-bold">Verifique o seu Email</h2>
            <p class="text-gray-600 mt-2">
              A sua conta ainda n茫o foi verificada. Por favor, insira o c贸digo enviado para<br/>
              <span id="verification-email" class="font-bold"></span>
            </p>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">C贸digo de Verifica莽茫o (6 d铆gitos)</span>
            </label>
            <input
              type="text"
              id="otp-code"
              placeholder="000000"
              class="input input-bordered text-center text-2xl tracking-widest"
              maxlength="6"
              pattern="[0-9]{6}"
              required
            />
          </div>

          <div id="otp-error" class="alert alert-error hidden">
            <span id="otp-error-message"></span>
          </div>

          <button type="button" class="btn btn-primary btn-block" id="verify-btn">
            <span id="verify-btn-text">Verificar C贸digo</span>
            <span id="verify-loading" class="loading loading-spinner hidden"></span>
          </button>

          <div class="text-center">
            <p class="text-sm text-gray-600">
              N茫o recebeu o c贸digo?
              <button type="button" class="btn btn-link btn-sm p-0" id="resend-btn">
                Reenviar c贸digo
              </button>
            </p>
          </div>

          <button type="button" class="btn btn-ghost btn-block" id="back-to-login">
            Voltar ao Login
          </button>
        </div>

        <div class="divider">OU</div>

        <p class="text-center text-sm">
          N茫o tem uma conta?
          <a href="/registar" class="link link-primary font-bold" id="register-link">Criar conta</a>
        </p>
      </div>
    </div>
  </div>

  <script>
    let currentEmail = '';

    function showError(elementId: string, message: string) {
      const errorDiv = document.getElementById(elementId);
      const errorMessage = document.getElementById(`${elementId}-message`);
      if (errorDiv && errorMessage) {
        errorMessage.textContent = message;
        errorDiv.classList.remove('hidden');
      }
    }

    function hideError(elementId: string) {
      const errorDiv = document.getElementById(elementId);
      if (errorDiv) {
        errorDiv.classList.add('hidden');
      }
    }

    function setLoading(buttonId: string, textId: string, loadingId: string, loading: boolean) {
      const btn = document.getElementById(buttonId) as HTMLButtonElement;
      const text = document.getElementById(textId);
      const spinner = document.getElementById(loadingId);

      if (btn && text && spinner) {
        btn.disabled = loading;
        text.classList.toggle('hidden', loading);
        spinner.classList.toggle('hidden', !loading);
      }
    }

    function showVerifySection(email: string) {
      currentEmail = email;
      document.getElementById('verification-email')!.textContent = email;
      document.getElementById('login-form')!.classList.add('hidden');
      document.getElementById('verify-section')!.classList.remove('hidden');
    }

    function showLoginSection() {
      document.getElementById('login-form')!.classList.remove('hidden');
      document.getElementById('verify-section')!.classList.add('hidden');
      hideError('otp-error');
    }

    // Login form submission
    document.getElementById('login-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError('login-error');

      const email = (document.getElementById('email') as HTMLInputElement).value;
      const password = (document.getElementById('password') as HTMLInputElement).value;

      setLoading('login-btn', 'login-btn-text', 'login-loading', true);

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const result = await response.json();

        if (result.success) {
          // Store session token
          localStorage.setItem('sessionToken', result.sessionToken);
          localStorage.setItem('user', JSON.stringify(result.user));

          // Redirect to account or previous page
          const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || '/conta';
          window.location.href = redirectUrl;
        } else if (result.needsVerification) {
          // User needs to verify email first
          showVerifySection(result.email);

          // Request a new OTP
          await fetch('/api/auth/resend-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: result.email }),
          });
        } else {
          showError('login-error', result.error || 'Erro ao fazer login');
        }
      } catch (error) {
        showError('login-error', 'Erro de conex茫o. Tente novamente.');
      } finally {
        setLoading('login-btn', 'login-btn-text', 'login-loading', false);
      }
    });

    // OTP verification
    document.getElementById('verify-btn')?.addEventListener('click', async () => {
      hideError('otp-error');

      const code = (document.getElementById('otp-code') as HTMLInputElement).value;

      if (code.length !== 6) {
        showError('otp-error', 'Por favor, insira o c贸digo de 6 d铆gitos');
        return;
      }

      setLoading('verify-btn', 'verify-btn-text', 'verify-loading', true);

      try {
        const response = await fetch('/api/auth/verify-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentEmail, code }),
        });

        const result = await response.json();

        if (result.success) {
          // Store session token
          localStorage.setItem('sessionToken', result.sessionToken);
          localStorage.setItem('user', JSON.stringify(result.user));

          // Redirect
          const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || '/conta';
          window.location.href = redirectUrl;
        } else {
          showError('otp-error', result.error || 'C贸digo inv谩lido');
        }
      } catch (error) {
        showError('otp-error', 'Erro de conex茫o. Tente novamente.');
      } finally {
        setLoading('verify-btn', 'verify-btn-text', 'verify-loading', false);
      }
    });

    // Resend OTP
    document.getElementById('resend-btn')?.addEventListener('click', async () => {
      const resendBtn = document.getElementById('resend-btn') as HTMLButtonElement;
      resendBtn.disabled = true;
      resendBtn.textContent = 'A enviar...';

      try {
        const response = await fetch('/api/auth/resend-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentEmail }),
        });

        const result = await response.json();

        if (result.success) {
          resendBtn.textContent = 'C贸digo reenviado!';
          setTimeout(() => {
            resendBtn.textContent = 'Reenviar c贸digo';
            resendBtn.disabled = false;
          }, 30000);
        } else {
          showError('otp-error', result.error || 'Erro ao reenviar c贸digo');
          resendBtn.textContent = 'Reenviar c贸digo';
          resendBtn.disabled = false;
        }
      } catch (error) {
        showError('otp-error', 'Erro de conex茫o');
        resendBtn.textContent = 'Reenviar c贸digo';
        resendBtn.disabled = false;
      }
    });

    // Back to login button
    document.getElementById('back-to-login')?.addEventListener('click', showLoginSection);

    // Auto-format OTP input
    document.getElementById('otp-code')?.addEventListener('input', (e) => {
      const input = e.target as HTMLInputElement;
      input.value = input.value.replace(/\D/g, '').slice(0, 6);
    });

    // Check if user is already logged in
    document.addEventListener('DOMContentLoaded', () => {
      const sessionToken = localStorage.getItem('sessionToken');
      if (sessionToken) {
        const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || '/conta';
        window.location.href = redirectUrl;
      }

      // Preserve redirect parameter in register link
      const redirectParam = new URLSearchParams(window.location.search).get('redirect');
      if (redirectParam) {
        const registerLink = document.getElementById('register-link') as HTMLAnchorElement;
        if (registerLink) {
          registerLink.href = `/registar?redirect=${encodeURIComponent(redirectParam)}`;
        }
      }
    });
  </script>
</Layout>
