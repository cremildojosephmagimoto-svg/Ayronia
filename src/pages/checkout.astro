---
import Layout from '@layouts/Layout.astro';
---

<Layout title="Checkout" description="Finalizar compra - Ayronia">
  <div class="min-h-screen bg-base-200">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-4xl font-bold mb-8">Finalizar Compra</h1>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
          <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
              <h2 class="card-title text-2xl mb-4">Dados de Entrega</h2>
              <form id="checkout-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text">Nome Completo</span>
                    </label>
                    <input type="text" placeholder="Nome completo" class="input input-bordered" required />
                  </div>
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text">Telefone</span>
                    </label>
                    <input type="tel" placeholder="+258 XX XXX XXXX" class="input input-bordered" required />
                  </div>
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">Email</span>
                  </label>
                  <input type="email" placeholder="seu@email.com" class="input input-bordered" required />
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">Morada Completa</span>
                  </label>
                  <textarea class="textarea textarea-bordered h-24" placeholder="Rua, nÃºmero, andar, etc." required></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text">Cidade</span>
                    </label>
                    <input type="text" placeholder="Cidade" class="input input-bordered" required />
                  </div>
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text">CÃ³digo Postal</span>
                    </label>
                    <input type="text" placeholder="1100" class="input input-bordered" />
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
              <h2 class="card-title text-2xl mb-4">MÃ©todo de Pagamento</h2>
              <div class="space-y-4">
                <div class="form-control">
                  <label class="label cursor-pointer border rounded-lg p-4 bg-primary/10 border-primary">
                    <div class="flex items-center gap-4">
                      <input type="radio" name="payment" class="radio radio-primary" value="pagamento_entrega" checked />
                      <div>
                        <div class="text-2xl mb-1">ðŸššðŸ’µ</div>
                        <span class="font-bold">Pagamento na Entrega</span>
                        <p class="text-sm text-gray-600">Pague ao receber o seu pedido</p>
                      </div>
                    </div>
                  </label>
                </div>

                <div id="pagamento-entrega-info" class="mt-4 p-4 bg-info/10 rounded-lg border border-info/30">
                  <h3 class="font-bold mb-3 text-info">Como funciona?</h3>
                  <ol class="list-decimal list-inside space-y-2 text-sm">
                    <li>Confirme o seu pedido agora</li>
                    <li>Receba o produto na sua morada</li>
                    <li>Efectue o pagamento ao entregador</li>
                    <li>Confirme o pagamento na sua conta</li>
                  </ol>
                  <div class="mt-3 p-2 bg-warning/20 rounded text-sm">
                    <strong>Nota:</strong> ApÃ³s o pagamento, aceda a "Meus Pedidos" na sua conta para confirmar o pagamento.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-1">
          <div class="card bg-base-100 shadow-xl sticky top-4">
            <div class="card-body">
              <h2 class="card-title text-2xl mb-4">Resumo do Pedido</h2>
              <div id="order-items" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
              </div>
              <div class="divider"></div>
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span>Subtotal:</span>
                  <span class="font-bold" id="checkout-subtotal">0 MT</span>
                </div>
                <div class="flex justify-between">
                  <span>Entrega:</span>
                  <span class="font-bold">50 MT</span>
                </div>
                <div class="divider my-2"></div>
                <div class="flex justify-between text-xl">
                  <span class="font-bold">Total:</span>
                  <span class="font-bold text-primary" id="checkout-total">50 MT</span>
                </div>
              </div>
              <div class="card-actions justify-end mt-6">
                <button class="btn btn-primary btn-block btn-lg" id="confirm-order">
                  Confirmar Pedido
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <dialog id="payment-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">A Processar Pedido</h3>
      <div class="text-center py-8">
        <div class="loading loading-spinner loading-lg mb-4"></div>
        <p id="payment-status">A registar o seu pedido...</p>
      </div>
    </div>
  </dialog>


  <dialog id="success-modal" class="modal">
    <div class="modal-box text-center">
      <div class="text-6xl mb-4">âœ…</div>
      <h3 class="font-bold text-2xl mb-4">Pedido Confirmado!</h3>
      <p class="mb-2">NÃºmero do pedido: <span class="font-bold" id="order-number"></span></p>
      <p class="mb-4">ReceberÃ¡ uma confirmaÃ§Ã£o por email e SMS.</p>
      <div class="alert alert-info text-left mb-6">
        <div>
          <p class="font-bold">PrÃ³ximos passos:</p>
          <ol class="list-decimal list-inside text-sm mt-2">
            <li>Aguarde a entrega do seu pedido</li>
            <li>Efectue o pagamento ao entregador</li>
            <li>Aceda a "Meus Pedidos" para confirmar o pagamento</li>
          </ol>
        </div>
      </div>
      <div class="modal-action justify-center gap-4">
        <a href="/meus-pedidos" class="btn btn-primary">Ver Meus Pedidos</a>
        <a href="/mercado" class="btn btn-outline">Continuar Comprando</a>
      </div>
    </div>
  </dialog>

  <script>
    interface CartItem {
      id: string;
      name: string;
      price: number;
      quantity: number;
    }

    // Verificar se o utilizador estÃ¡ autenticado
    async function checkAuthentication(): Promise<boolean> {
      const sessionToken = localStorage.getItem('sessionToken');

      if (!sessionToken) {
        return false;
      }

      try {
        const response = await fetch('/api/auth/status', {
          headers: {
            'Authorization': `Bearer ${sessionToken}`
          }
        });

        const data = await response.json();
        return data.authenticated === true;
      } catch {
        return false;
      }
    }

    function renderOrderSummary() {
      const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');
      const orderItemsDiv = document.getElementById('order-items');
      const subtotalEl = document.getElementById('checkout-subtotal');
      const totalEl = document.getElementById('checkout-total');

      if (!orderItemsDiv || !subtotalEl || !totalEl) return;

      if (cart.length === 0) {
        window.location.href = '/mercado';
        return;
      }

      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const total = subtotal + 50;

      subtotalEl.textContent = `${subtotal} MT`;
      totalEl.textContent = `${total} MT`;

      orderItemsDiv.innerHTML = cart.map(item => `
        <div class="flex justify-between text-sm">
          <span>${item.name} x${item.quantity}</span>
          <span class="font-bold">${item.price * item.quantity} MT</span>
        </div>
      `).join('');
    }

    // Preencher dados do utilizador autenticado no formulÃ¡rio
    function fillUserData() {
      const userData = localStorage.getItem('user');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          const form = document.getElementById('checkout-form') as HTMLFormElement;
          if (form) {
            const nameInput = form.querySelector('input[type="text"]') as HTMLInputElement;
            const phoneInput = document.querySelector('input[type="tel"]') as HTMLInputElement;
            const emailInput = document.querySelector('input[type="email"]') as HTMLInputElement;

            if (nameInput && user.name) nameInput.value = user.name;
            if (phoneInput && user.phone) phoneInput.value = user.phone;
            if (emailInput && user.email) emailInput.value = user.email;
          }
        } catch {
          // Ignorar erros de parsing
        }
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Verificar autenticaÃ§Ã£o antes de permitir checkout
      const isAuthenticated = await checkAuthentication();

      if (!isAuthenticated) {
        // Redirecionar para login com retorno para checkout
        alert('Para finalizar a compra, precisa estar registado e fazer login na plataforma.');
        window.location.href = '/login?redirect=/checkout';
        return;
      }

      renderOrderSummary();
      fillUserData();

      document.getElementById('confirm-order')?.addEventListener('click', async () => {
        const form = document.getElementById('checkout-form') as HTMLFormElement;
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const nameInput = form.querySelector('input[type="text"]') as HTMLInputElement;
        const phoneInput = document.querySelector('input[type="tel"]') as HTMLInputElement;
        const emailInput = document.querySelector('input[type="email"]') as HTMLInputElement;
        const addressInput = form.querySelector('textarea') as HTMLTextAreaElement;
        const cityInput = form.querySelectorAll('input[type="text"]')[1] as HTMLInputElement;
        const postalCodeInput = form.querySelectorAll('input[type="text"]')[2] as HTMLInputElement;

        const customerName = nameInput?.value;
        const phone = phoneInput?.value;
        const email = emailInput?.value;
        const address = addressInput?.value;
        const city = cityInput?.value;
        const postalCode = postalCodeInput?.value || '';

        if (!phone || !customerName || !email || !address || !city) {
          alert('Por favor, preencha todos os campos obrigatÃ³rios.');
          return;
        }

        const paymentMethod = (document.querySelector('input[name="payment"]:checked') as HTMLInputElement)?.value;
        
        const modal = document.getElementById('payment-modal') as HTMLDialogElement;
        const statusEl = document.getElementById('payment-status');
        
        modal?.showModal();

        statusEl!.textContent = 'A registar o seu pedido...';

        const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const deliveryFee = 50;
        const total = subtotal + deliveryFee;

        const orderNumber = 'AYR' + Math.floor(Math.random() * 1000000).toString().padStart(6, '0');

        try {
          const sessionToken = localStorage.getItem('sessionToken');
          const response = await fetch('/api/send-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${sessionToken}`,
            },
            body: JSON.stringify({
              orderNumber,
              customerName,
              customerEmail: email,
              customerPhone: phone,
              address,
              city,
              postalCode,
              items: cart,
              subtotal,
              deliveryFee,
              total,
              paymentMethod,
            }),
          });

          const result = await response.json();

          if (result.success) {
            if (result.whatsappAdminUrl) {
              window.open(result.whatsappAdminUrl, '_blank');
            }

            modal?.close();
            document.getElementById('order-number')!.textContent = orderNumber;
            localStorage.removeItem('cart');

            const successModal = document.getElementById('success-modal') as HTMLDialogElement;
            successModal?.showModal();
          } else {
            throw new Error(result.error || 'Erro ao processar pedido');
          }
        } catch (error) {
          modal?.close();
          alert('Ocorreu um erro ao processar o pedido. Por favor, tente novamente ou contacte-nos.');
          console.error('Order processing error:', error);
        }
      });

    });
  </script>
</Layout>
