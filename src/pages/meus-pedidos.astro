---
import Layout from '@layouts/Layout.astro';
---

<Layout title="Meus Pedidos" description="Veja os seus pedidos - Ayronia">
  <div class="min-h-screen bg-base-200">
    <div class="container mx-auto px-4 py-8">
      <!-- Loading state -->
      <div id="loading-state" class="flex items-center justify-center min-h-[60vh]">
        <span class="loading loading-spinner loading-lg"></span>
      </div>

      <!-- Not logged in state -->
      <div id="not-logged-in" class="hidden flex items-center justify-center min-h-[60vh]">
        <div class="card bg-base-100 shadow-xl w-full max-w-md">
          <div class="card-body text-center">
            <div class="text-6xl mb-4">üîí</div>
            <h2 class="card-title justify-center text-2xl mb-4">Acesso Restrito</h2>
            <p class="mb-6">Por favor, fa√ßa login para ver os seus pedidos.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
              <a href="/login" class="btn btn-primary">Entrar</a>
              <a href="/registar" class="btn btn-outline">Criar Conta</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Logged in state -->
      <div id="logged-in" class="hidden">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
          <div>
            <h1 class="text-4xl font-bold">Meus Pedidos</h1>
            <p class="text-gray-600 mt-2">Acompanhe e confirme o pagamento dos seus pedidos</p>
          </div>
          <a href="/mercado" class="btn btn-primary">
            Continuar Comprando
          </a>
        </div>

        <!-- Empty state -->
        <div id="empty-orders" class="hidden">
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body text-center py-16">
              <div class="text-6xl mb-4">üì¶</div>
              <h2 class="text-2xl font-bold mb-2">Nenhum pedido encontrado</h2>
              <p class="text-gray-600 mb-6">Ainda n√£o fez nenhum pedido. Visite o nosso mercado para come√ßar!</p>
              <a href="/mercado" class="btn btn-primary">Ir para o Mercado</a>
            </div>
          </div>
        </div>

        <!-- Orders list -->
        <div id="orders-list" class="space-y-6">
          <!-- Orders will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Confirmation Modal -->
  <dialog id="confirm-payment-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Confirmar Pagamento</h3>
      <p class="mb-4">Confirma que efectuou o pagamento do pedido <span id="modal-order-number" class="font-bold"></span>?</p>
      <div class="alert alert-warning mb-4">
        <div>
          <p class="text-sm">Apenas confirme o pagamento se j√° entregou o valor ao entregador.</p>
        </div>
      </div>
      <div class="modal-action">
        <button class="btn btn-outline" id="cancel-confirm">Cancelar</button>
        <button class="btn btn-primary" id="submit-confirm">Confirmar Pagamento</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Success Modal -->
  <dialog id="success-modal" class="modal">
    <div class="modal-box text-center">
      <div class="text-6xl mb-4">‚úÖ</div>
      <h3 class="font-bold text-2xl mb-4">Pagamento Confirmado!</h3>
      <p class="mb-6">O seu pagamento foi registado com sucesso.</p>
      <div class="modal-action justify-center">
        <button class="btn btn-primary" id="close-success">Fechar</button>
      </div>
    </div>
  </dialog>

  <script>
    type OrderStatus = 'pendente' | 'em_preparacao' | 'em_entrega' | 'entregue' | 'pago' | 'cancelado';
    type PaymentStatus = 'aguardando_pagamento' | 'pago' | 'confirmado';

    interface OrderItem {
      name: string;
      quantity: number;
      price: number;
    }

    interface Order {
      orderNumber: string;
      customerName: string;
      customerEmail: string;
      customerPhone: string;
      address: string;
      city: string;
      postalCode: string;
      items: OrderItem[];
      subtotal: number;
      deliveryFee: number;
      total: number;
      paymentMethod: string;
      paymentStatus: PaymentStatus;
      orderStatus: OrderStatus;
      createdAt: string;
      updatedAt: string;
      paidAt?: string;
      paymentConfirmedByCustomer?: boolean;
    }

    const ORDER_STATUS_LABELS: Record<OrderStatus, string> = {
      pendente: 'Pendente',
      em_preparacao: 'Em Prepara√ß√£o',
      em_entrega: 'Em Entrega',
      entregue: 'Entregue',
      pago: 'Pago',
      cancelado: 'Cancelado',
    };

    const ORDER_STATUS_COLORS: Record<OrderStatus, string> = {
      pendente: 'badge-warning',
      em_preparacao: 'badge-info',
      em_entrega: 'badge-primary',
      entregue: 'badge-success',
      pago: 'badge-success',
      cancelado: 'badge-error',
    };

    const PAYMENT_STATUS_LABELS: Record<PaymentStatus, string> = {
      aguardando_pagamento: 'Aguardando Pagamento',
      pago: 'Pago pelo Cliente',
      confirmado: 'Confirmado',
    };

    const PAYMENT_STATUS_COLORS: Record<PaymentStatus, string> = {
      aguardando_pagamento: 'badge-warning',
      pago: 'badge-success',
      confirmado: 'badge-success',
    };

    async function checkAuthStatus(): Promise<{ authenticated: boolean; token?: string }> {
      const sessionToken = localStorage.getItem('sessionToken');
      const storedUser = localStorage.getItem('user');

      if (!sessionToken || !storedUser) {
        return { authenticated: false };
      }

      try {
        const response = await fetch('/api/auth/status', {
          headers: {
            Authorization: `Bearer ${sessionToken}`,
          },
        });

        if (response.ok) {
          const result = await response.json();
          return { authenticated: result.authenticated, token: sessionToken };
        }
        return { authenticated: false };
      } catch {
        // On error, still try to use stored token
        return { authenticated: true, token: sessionToken };
      }
    }

    async function fetchOrders(token: string): Promise<Order[]> {
      try {
        const response = await fetch('/api/orders/', {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        if (!response.ok) {
          throw new Error('Failed to fetch orders');
        }

        const result = await response.json();
        return result.orders || [];
      } catch (error) {
        console.error('Error fetching orders:', error);
        return [];
      }
    }

    async function confirmPayment(orderNumber: string, token: string): Promise<boolean> {
      try {
        const response = await fetch(`/api/orders/${orderNumber}/confirm-payment`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        return response.ok;
      } catch (error) {
        console.error('Error confirming payment:', error);
        return false;
      }
    }

    function formatDate(dateString: string): string {
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-PT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
    }

    function renderOrders(orders: Order[], token: string) {
      const ordersListEl = document.getElementById('orders-list');
      const emptyOrdersEl = document.getElementById('empty-orders');

      if (!ordersListEl || !emptyOrdersEl) return;

      if (orders.length === 0) {
        emptyOrdersEl.classList.remove('hidden');
        ordersListEl.classList.add('hidden');
        return;
      }

      emptyOrdersEl.classList.add('hidden');
      ordersListEl.classList.remove('hidden');

      ordersListEl.innerHTML = orders.map(order => `
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
              <div>
                <h2 class="card-title text-xl">
                  Pedido #${order.orderNumber}
                </h2>
                <p class="text-sm text-gray-600">${formatDate(order.createdAt)}</p>
              </div>
              <div class="flex flex-wrap gap-2">
                <span class="badge ${ORDER_STATUS_COLORS[order.orderStatus]} badge-lg">
                  ${ORDER_STATUS_LABELS[order.orderStatus]}
                </span>
                <span class="badge ${PAYMENT_STATUS_COLORS[order.paymentStatus]} badge-lg">
                  ${PAYMENT_STATUS_LABELS[order.paymentStatus]}
                </span>
              </div>
            </div>

            <div class="divider my-2"></div>

            <!-- Order Items -->
            <div class="space-y-2 mb-4">
              <h3 class="font-bold text-sm text-gray-600">Itens do Pedido:</h3>
              ${order.items.map(item => `
                <div class="flex justify-between text-sm">
                  <span>${item.name} x${item.quantity}</span>
                  <span class="font-bold">${item.price * item.quantity} MT</span>
                </div>
              `).join('')}
            </div>

            <div class="divider my-2"></div>

            <!-- Order Summary -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h3 class="font-bold text-sm text-gray-600 mb-2">Endere√ßo de Entrega:</h3>
                <p class="text-sm">${order.address}</p>
                <p class="text-sm">${order.city}${order.postalCode ? `, ${order.postalCode}` : ''}</p>
              </div>
              <div class="text-right">
                <div class="text-sm">Subtotal: <span class="font-bold">${order.subtotal} MT</span></div>
                <div class="text-sm">Taxa de Entrega: <span class="font-bold">${order.deliveryFee} MT</span></div>
                <div class="text-xl mt-2">Total: <span class="font-bold text-primary">${order.total} MT</span></div>
              </div>
            </div>

            ${order.paymentStatus === 'aguardando_pagamento' && !order.paymentConfirmedByCustomer ? `
              <div class="divider my-2"></div>
              <div class="alert alert-info">
                <div>
                  <p class="font-bold">Pagamento na Entrega</p>
                  <p class="text-sm">Ap√≥s efectuar o pagamento ao entregador, clique no bot√£o abaixo para confirmar.</p>
                </div>
              </div>
              <div class="card-actions justify-end mt-4">
                <button class="btn btn-primary confirm-payment-btn" data-order="${order.orderNumber}">
                  Confirmar Pagamento
                </button>
              </div>
            ` : order.paymentConfirmedByCustomer ? `
              <div class="divider my-2"></div>
              <div class="alert alert-success">
                <div>
                  <p class="font-bold">Pagamento Confirmado</p>
                  <p class="text-sm">Voc√™ confirmou o pagamento em ${order.paidAt ? formatDate(order.paidAt) : 'data desconhecida'}.</p>
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `).join('');

      // Add event listeners for confirm payment buttons
      document.querySelectorAll('.confirm-payment-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const orderNumber = (btn as HTMLElement).dataset.order;
          if (orderNumber) {
            openConfirmModal(orderNumber, token);
          }
        });
      });
    }

    function openConfirmModal(orderNumber: string, token: string) {
      const modal = document.getElementById('confirm-payment-modal') as HTMLDialogElement;
      const orderNumberEl = document.getElementById('modal-order-number');
      const submitBtn = document.getElementById('submit-confirm');
      const cancelBtn = document.getElementById('cancel-confirm');

      if (!modal || !orderNumberEl || !submitBtn || !cancelBtn) return;

      orderNumberEl.textContent = orderNumber;
      modal.showModal();

      // Remove existing listeners
      const newSubmitBtn = submitBtn.cloneNode(true) as HTMLElement;
      submitBtn.parentNode?.replaceChild(newSubmitBtn, submitBtn);

      const newCancelBtn = cancelBtn.cloneNode(true) as HTMLElement;
      cancelBtn.parentNode?.replaceChild(newCancelBtn, cancelBtn);

      newCancelBtn.addEventListener('click', () => {
        modal.close();
      });

      newSubmitBtn.addEventListener('click', async () => {
        newSubmitBtn.classList.add('loading');
        const success = await confirmPayment(orderNumber, token);
        newSubmitBtn.classList.remove('loading');
        modal.close();

        if (success) {
          const successModal = document.getElementById('success-modal') as HTMLDialogElement;
          successModal?.showModal();

          // Refresh orders
          const orders = await fetchOrders(token);
          renderOrders(orders, token);
        } else {
          alert('Erro ao confirmar o pagamento. Por favor, tente novamente.');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const loadingState = document.getElementById('loading-state');
      const notLoggedIn = document.getElementById('not-logged-in');
      const loggedIn = document.getElementById('logged-in');

      const auth = await checkAuthStatus();

      loadingState?.classList.add('hidden');

      if (!auth.authenticated || !auth.token) {
        notLoggedIn?.classList.remove('hidden');
        return;
      }

      loggedIn?.classList.remove('hidden');

      const orders = await fetchOrders(auth.token);
      renderOrders(orders, auth.token);

      // Close success modal
      document.getElementById('close-success')?.addEventListener('click', () => {
        const modal = document.getElementById('success-modal') as HTMLDialogElement;
        modal?.close();
      });
    });
  </script>
</Layout>
