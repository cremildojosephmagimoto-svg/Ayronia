---
import Layout from '@layouts/Layout.astro';

interface Product {
  id: string;
  name: string;
  price: number;
  category: string;
  image: string;
  description: string;
}

const products: Product[] = [
  { id: '1', name: 'Arroz Carolino 1kg', price: 85, category: 'Alimentar', image: '/images/arroz.jpg', description: 'Arroz de qualidade premium' },
  { id: '2', name: 'Feij√£o Manteiga 500g', price: 120, category: 'Alimentar', image: '/images/feijao.jpg', description: 'Feij√£o manteiga selecionado' },
  { id: '3', name: '√ìleo Vegetal 750ml', price: 150, category: 'Alimentar', image: '/images/oleo.jpg', description: '√ìleo vegetal refinado' },
  { id: '4', name: 'Frango Inteiro 1.5kg', price: 450, category: 'Talho', image: '/images/frango.jpg', description: 'Frango fresco do dia' },
  { id: '5', name: 'Carne de Vaca 1kg', price: 650, category: 'Talho', image: '/images/vaca.jpg', description: 'Carne de vaca premium' },
  { id: '6', name: 'Costeletas de Porco 800g', price: 380, category: 'Talho', image: '/images/costeletas.jpg', description: 'Costeletas frescas' },
  { id: '7', name: 'Peixe Congelado 600g', price: 320, category: 'Congelados', image: '/images/peixe.jpg', description: 'Peixe congelado premium' },
  { id: '8', name: 'Batatas Fritas 1kg', price: 180, category: 'Congelados', image: '/images/batatas.jpg', description: 'Batatas pr√©-fritas congeladas' },
  { id: '9', name: 'Vegetais Mix 500g', price: 140, category: 'Congelados', image: '/images/vegetais.jpg', description: 'Mix de vegetais congelados' },
  { id: '10', name: 'Detergente 500ml', price: 95, category: 'Limpeza', image: '/images/detergente.jpg', description: 'Detergente multiusos' },
  { id: '11', name: 'Sab√£o em P√≥ 1kg', price: 120, category: 'Limpeza', image: '/images/sabao.jpg', description: 'Sab√£o para roupa' },
  { id: '12', name: 'Desinfetante 1L', price: 150, category: 'Limpeza', image: '/images/desinfetante.jpg', description: 'Desinfetante antibacteriano' }
];

const categories = ['Todos', 'Alimentar', 'Talho', 'Congelados', 'Limpeza'];
---

<Layout title="Mercado" description="Loja online Ayronia - Produtos de qualidade">
  <div class="min-h-screen bg-base-200">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-4xl font-bold text-center mb-8">üõí Mercado</h1>
      <p class="text-center text-xl mb-8 text-base-content/70">Produtos alimentares, limpeza e congelados com entrega ao domic√≠lio</p>
      
      <button 
        id="floating-cart-btn"
        class="btn btn-primary btn-circle btn-lg fixed bottom-28 right-8 z-50 shadow-2xl hover:scale-110 transition-transform"
      >
        <div class="indicator">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span class="badge badge-sm indicator-item" id="cart-count">0</span>
        </div>
      </button>

      <div id="produtos-section">
        <div class="max-w-2xl mx-auto mb-8">
          <div class="form-control">
            <div class="input-group">
              <input 
                type="text" 
                id="search-input"
                placeholder="Pesquisar produtos..." 
                class="input input-bordered w-full"
              />
              <button class="btn btn-square btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 justify-center mb-8">
          {categories.map(cat => (
            <button 
              class="btn btn-outline category-filter" 
              data-category={cat}
            >
              {cat}
            </button>
          ))}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="products-grid">
        {products.map(product => (
          <div class="card bg-base-100 shadow-xl product-card fade-in-up" data-category={product.category}>
            <figure class="bg-gradient-to-br from-base-200 to-base-300 h-56 flex items-center justify-center relative overflow-hidden">
              <div class="absolute inset-0 bg-base-300/20"></div>
              <span class="text-7xl relative z-10 transform hover:scale-110 transition-transform duration-300">{
                product.category === 'Alimentar' ? 'üåæ' :
                product.category === 'Talho' ? 'ü•©' :
                product.category === 'Congelados' ? '‚ùÑÔ∏è' :
                'üßº'
              }</span>
            </figure>
            <div class="card-body mobile-center">
              <h2 class="card-title text-lg justify-center md:justify-start">
                {product.name}
              </h2>
              <p class="text-sm text-base-content/70">{product.description}</p>
              <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-4">
                <span class="text-2xl font-bold text-primary">{product.price} MT</span>
                <div class="flex gap-2">
                  <button 
                    class="btn btn-outline btn-sm open-product-modal"
                    data-product={JSON.stringify(product)}
                  >
                    Ver detalhes
                  </button>
                  <button 
                    class="btn btn-primary btn-sm add-to-cart-direct"
                    data-product={JSON.stringify(product)}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        ))}
        </div>
      </div>

      <div id="product-modal" class="modal">
        <div class="modal-box w-11/12 max-w-3xl">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-2xl" id="modal-product-name"></h3>
            <button class="btn btn-sm btn-circle btn-ghost" id="close-product-modal">‚úï</button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex flex-col items-center">
              <figure class="bg-gradient-to-br from-base-200 to-base-300 w-full h-64 flex items-center justify-center relative overflow-hidden rounded-lg shadow-lg">
                <div class="absolute inset-0 bg-base-300/20"></div>
                <span class="text-9xl relative z-10" id="modal-product-emoji"></span>
              </figure>
              <div class="mt-4 flex gap-2" id="modal-product-badges"></div>
            </div>
            
            <div class="flex flex-col justify-between">
              <div>
                <p class="text-base-content/70 mb-4" id="modal-product-description"></p>
                <p class="text-3xl font-bold text-primary mb-6" id="modal-product-price"></p>
              </div>
              
              <div class="space-y-4">
                <div class="form-control">
                  <label class="label">
                    <span class="label-text font-semibold">Quantidade</span>
                  </label>
                  <div class="flex items-center gap-4">
                    <button class="btn btn-circle btn-lg" id="modal-decrease-qty">-</button>
                    <input 
                      type="number" 
                      class="input input-bordered w-24 text-center text-xl font-bold" 
                      id="modal-quantity" 
                      value="1" 
                      min="1"
                      readonly
                    />
                    <button class="btn btn-circle btn-lg" id="modal-increase-qty">+</button>
                  </div>
                </div>
                
                <button class="btn btn-primary btn-block btn-lg" id="modal-confirm-add">
                  Confirmar - <span id="modal-total-price"></span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-backdrop" id="product-modal-backdrop"></div>
      </div>

      <div id="carrinho-modal" class="modal">
        <div class="modal-box w-11/12 max-w-5xl max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-2xl">üõí Seu Carrinho</h3>
            <button class="btn btn-sm btn-circle btn-ghost" id="close-cart-modal">‚úï</button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
              <div id="cart-items">
              </div>
              <div id="empty-cart" class="text-center py-12 hidden">
                <div class="text-6xl mb-4">üõí</div>
                <h2 class="text-2xl font-bold mb-4">Seu carrinho est√° vazio</h2>
                <button class="btn btn-primary" id="back-to-products">Continuar Comprando</button>
              </div>
            </div>

            <div class="lg:col-span-1">
              <div class="card bg-base-200 shadow-xl">
                <div class="card-body">
                  <h2 class="card-title text-2xl mb-4">Resumo do Pedido</h2>
                  <div class="space-y-3">
                    <div class="flex justify-between">
                      <span>Subtotal:</span>
                      <span class="font-bold" id="subtotal">0 MT</span>
                    </div>
                    <div class="flex justify-between">
                      <span>Entrega:</span>
                      <span class="font-bold">50 MT</span>
                    </div>
                    <div class="divider my-2"></div>
                    <div class="flex justify-between text-xl">
                      <span class="font-bold">Total:</span>
                      <span class="font-bold text-primary" id="total">50 MT</span>
                    </div>
                  </div>
                  <div class="card-actions justify-end mt-6">
                    <a href="/checkout" class="btn btn-primary btn-block btn-lg" id="checkout-btn">
                      Finalizar Compra
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-backdrop" id="cart-modal-backdrop"></div>
      </div>
    </div>
  </div>

  <script>
    interface CartItem {
      id: string;
      name: string;
      price: number;
      category: string;
      image: string;
      description: string;
      quantity: number;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const floatingCartBtn = document.getElementById('floating-cart-btn');
      const carrinhoModal = document.getElementById('carrinho-modal');
      const closeCartModal = document.getElementById('close-cart-modal');
      const cartModalBackdrop = document.getElementById('cart-modal-backdrop');
      const cartCountBadge = document.getElementById('cart-count');
      const backToProductsBtn = document.getElementById('back-to-products');

      function openCartModal() {
        carrinhoModal?.classList.add('modal-open');
        renderCart();
      }

      function closeModal() {
        carrinhoModal?.classList.remove('modal-open');
      }

      floatingCartBtn?.addEventListener('click', openCartModal);
      closeCartModal?.addEventListener('click', closeModal);
      cartModalBackdrop?.addEventListener('click', closeModal);
      backToProductsBtn?.addEventListener('click', closeModal);

      function updateCartCount() {
        const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        if (cartCountBadge) {
          cartCountBadge.textContent = totalItems.toString();
        }
      }

      function renderCart() {
        const cartItemsDiv = document.getElementById('cart-items');
        const emptyCartDiv = document.getElementById('empty-cart');
        const subtotalEl = document.getElementById('subtotal');
        const totalEl = document.getElementById('total');
        const checkoutBtn = document.getElementById('checkout-btn');
        
        if (!cartItemsDiv || !emptyCartDiv || !subtotalEl || !totalEl || !checkoutBtn) return;

        const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');

        if (cart.length === 0) {
          cartItemsDiv.innerHTML = '';
          emptyCartDiv.classList.remove('hidden');
          checkoutBtn.classList.add('btn-disabled');
          return;
        }

        emptyCartDiv.classList.add('hidden');
        checkoutBtn.classList.remove('btn-disabled');

        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const deliveryFee = 50;
        const total = subtotal + deliveryFee;

        subtotalEl.textContent = `${subtotal} MT`;
        totalEl.textContent = `${total} MT`;

        cartItemsDiv.innerHTML = cart.map(item => `
          <div class="flex gap-4 p-4 border-b" data-item-id="${item.id}">
            <div class="w-20 h-20 bg-gray-200 rounded flex items-center justify-center text-3xl">
              ${item.category === 'Alimentar' ? 'üåæ' :
                item.category === 'Talho' ? 'ü•©' :
                item.category === 'Congelados' ? '‚ùÑÔ∏è' : 'üßº'}
            </div>
            <div class="flex-1">
              <h3 class="font-bold text-lg">${item.name}</h3>
              <p class="text-lg font-bold mt-2">${item.price} MT</p>
            </div>
            <div class="flex flex-col items-end justify-between">
              <button class="btn btn-ghost btn-sm btn-circle remove-item" data-id="${item.id}">‚úï</button>
              <div class="flex items-center gap-2">
                <button class="btn btn-sm decrease-qty" data-id="${item.id}">-</button>
                <span class="px-4 font-bold">${item.quantity}</span>
                <button class="btn btn-sm increase-qty" data-id="${item.id}">+</button>
              </div>
              <p class="font-bold text-lg">${item.price * item.quantity} MT</p>
            </div>
          </div>
        `).join('');

        document.querySelectorAll('.remove-item').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const newCart = cart.filter((item: CartItem) => item.id !== id);
            localStorage.setItem('cart', JSON.stringify(newCart));
            renderCart();
            updateCartCount();
          });
        });

        document.querySelectorAll('.increase-qty').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const item = cart.find((item: CartItem) => item.id === id);
            if (item) {
              item.quantity += 1;
              localStorage.setItem('cart', JSON.stringify(cart));
              renderCart();
              updateCartCount();
            }
          });
        });

        document.querySelectorAll('.decrease-qty').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const item = cart.find((item: CartItem) => item.id === id);
            if (item && item.quantity > 1) {
              item.quantity -= 1;
              localStorage.setItem('cart', JSON.stringify(cart));
              renderCart();
              updateCartCount();
            }
          });
        });
      }

      updateCartCount();

      const filters = document.querySelectorAll('.category-filter');
      const products = document.querySelectorAll('.product-card');
      const searchInput = document.getElementById('search-input') as HTMLInputElement;
      let currentCategory = 'Todos';
      
      function filterProducts() {
        const searchTerm = searchInput.value.toLowerCase();
        
        products.forEach(product => {
          const productElement = product as HTMLElement;
          const productCategory = productElement.dataset.category;
          const productName = productElement.querySelector('.card-title')?.textContent?.toLowerCase() || '';
          const productDescription = productElement.querySelector('.text-sm')?.textContent?.toLowerCase() || '';
          
          const matchesCategory = currentCategory === 'Todos' || productCategory === currentCategory;
          const matchesSearch = searchTerm === '' || 
                                productName.includes(searchTerm) || 
                                productDescription.includes(searchTerm);
          
          if (matchesCategory && matchesSearch) {
            productElement.style.display = 'block';
          } else {
            productElement.style.display = 'none';
          }
        });
      }
      
      searchInput.addEventListener('input', filterProducts);
      
      filters.forEach(filter => {
        filter.addEventListener('click', (e) => {
          currentCategory = (e.target as HTMLElement).dataset.category || 'Todos';
          
          filters.forEach(f => f.classList.remove('btn-active'));
          (e.target as HTMLElement).classList.add('btn-active');
          
          filterProducts();
        });
      });

      const productModal = document.getElementById('product-modal');
      const closeProductModal = document.getElementById('close-product-modal');
      const productModalBackdrop = document.getElementById('product-modal-backdrop');
      const modalQuantity = document.getElementById('modal-quantity') as HTMLInputElement;
      const modalIncreaseQty = document.getElementById('modal-increase-qty');
      const modalDecreaseQty = document.getElementById('modal-decrease-qty');
      const modalConfirmAdd = document.getElementById('modal-confirm-add');
      
      let currentProduct: any = null;
      
      function getEmojiForCategory(category: string): string {
        switch(category) {
          case 'Alimentar': return 'üåæ';
          case 'Talho': return 'ü•©';
          case 'Congelados': return '‚ùÑÔ∏è';
          case 'Limpeza': return 'üßº';
          default: return 'üì¶';
        }
      }
      
      function openProductModal(product: any) {
        currentProduct = product;
        modalQuantity!.value = '1';
        
        document.getElementById('modal-product-name')!.textContent = product.name;
        document.getElementById('modal-product-emoji')!.textContent = getEmojiForCategory(product.category);
        document.getElementById('modal-product-description')!.textContent = product.description;
        document.getElementById('modal-product-price')!.textContent = `${product.price} MT`;
        
        const badgesDiv = document.getElementById('modal-product-badges')!;
        badgesDiv.innerHTML = ``;
        
        updateModalTotalPrice();
        productModal?.classList.add('modal-open');
      }
      
      function closeProductModalFunc() {
        productModal?.classList.remove('modal-open');
        currentProduct = null;
      }
      
      function updateModalTotalPrice() {
        if (!currentProduct || !modalQuantity) return;
        const quantity = parseInt(modalQuantity.value);
        const total = currentProduct.price * quantity;
        document.getElementById('modal-total-price')!.textContent = `${total} MT`;
      }
      
      closeProductModal?.addEventListener('click', closeProductModalFunc);
      productModalBackdrop?.addEventListener('click', closeProductModalFunc);
      
      modalIncreaseQty?.addEventListener('click', () => {
        if (modalQuantity) {
          const currentValue = parseInt(modalQuantity.value);
          modalQuantity.value = (currentValue + 1).toString();
          updateModalTotalPrice();
        }
      });
      
      modalDecreaseQty?.addEventListener('click', () => {
        if (modalQuantity) {
          const currentValue = parseInt(modalQuantity.value);
          if (currentValue > 1) {
            modalQuantity.value = (currentValue - 1).toString();
            updateModalTotalPrice();
          }
        }
      });
      
      modalConfirmAdd?.addEventListener('click', () => {
        if (!currentProduct || !modalQuantity) return;
        
        const quantity = parseInt(modalQuantity.value);
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        const existingItem = cart.find((item: any) => item.id === currentProduct.id);
        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({ ...currentProduct, quantity });
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
        
        closeProductModalFunc();
        
        const toast = document.createElement('div');
        toast.className = 'alert alert-success fixed top-4 right-4 w-auto z-[100] shadow-lg';
        toast.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>${quantity}x ${currentProduct.name} adicionado ao carrinho!</span>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      });
      
      const openProductModalButtons = document.querySelectorAll('.open-product-modal');
      openProductModalButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          const productData = (e.target as HTMLElement).dataset.product;
          if (productData) {
            const product = JSON.parse(productData);
            openProductModal(product);
          }
        });
      });

      const addToCartDirectButtons = document.querySelectorAll('.add-to-cart-direct');
      addToCartDirectButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          const target = e.target as HTMLElement;
          const buttonElement = target.closest('button') as HTMLElement;
          const productData = buttonElement?.dataset.product;
          if (productData) {
            const product = JSON.parse(productData);
            
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const existingItem = cart.find((item: any) => item.id === product.id);
            
            if (existingItem) {
              existingItem.quantity += 1;
            } else {
              cart.push({ ...product, quantity: 1 });
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            
            const toast = document.createElement('div');
            toast.className = 'alert alert-success fixed top-4 right-4 w-auto z-[100] shadow-lg';
            toast.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
              <span>${product.name} adicionado ao carrinho!</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
          }
        });
      });
    });
  </script>
</Layout>
