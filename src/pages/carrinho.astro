---
import Layout from '@layouts/Layout.astro';
---

<Layout title="Carrinho de Compras" description="Seu carrinho de compras Ayronia">
  <div class="min-h-screen bg-base-200">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-4xl font-bold mb-8">Carrinho de Compras</h1>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
              <div id="cart-items">
              </div>
              <div id="empty-cart" class="text-center py-12 hidden">
                <div class="text-6xl mb-4">üõí</div>
                <h2 class="text-2xl font-bold mb-4">Seu carrinho est√° vazio</h2>
                <a href="/mercado" class="btn btn-primary">Continuar Comprando</a>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-1">
          <div class="card bg-base-100 shadow-xl sticky top-4">
            <div class="card-body">
              <h2 class="card-title text-2xl mb-4">Resumo do Pedido</h2>
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span>Subtotal:</span>
                  <span class="font-bold" id="subtotal">0 MT</span>
                </div>
                <div class="flex justify-between">
                  <span>Entrega:</span>
                  <span class="font-bold">50 MT</span>
                </div>
                <div class="divider my-2"></div>
                <div class="flex justify-between text-xl">
                  <span class="font-bold">Total:</span>
                  <span class="font-bold text-primary" id="total">50 MT</span>
                </div>
              </div>
              <div class="card-actions justify-end mt-6">
                <div id="login-notice" class="hidden w-full mb-3">
                  <div class="alert alert-warning text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    <span>Para finalizar a compra, precisa de iniciar sess√£o ou registar-se.</span>
                  </div>
                </div>
                <a href="/checkout" class="btn btn-primary btn-block btn-lg" id="checkout-btn">
                  Finalizar Compra
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    interface CartItem {
      id: string;
      name: string;
      price: number;
      category: string;
      image: string;
      description: string;
      quantity: number;
    }

    // Verificar se o utilizador est√° autenticado
    async function checkAuthentication(): Promise<boolean> {
      const sessionToken = localStorage.getItem('sessionToken');

      if (!sessionToken) {
        return false;
      }

      try {
        const response = await fetch('/api/auth/status', {
          headers: {
            'Authorization': `Bearer ${sessionToken}`
          }
        });

        const data = await response.json();
        return data.authenticated === true;
      } catch {
        return false;
      }
    }

    async function updateCheckoutButton() {
      const checkoutBtn = document.getElementById('checkout-btn') as HTMLAnchorElement;
      const loginNotice = document.getElementById('login-notice');
      const isAuthenticated = await checkAuthentication();

      if (checkoutBtn && loginNotice) {
        if (!isAuthenticated) {
          loginNotice.classList.remove('hidden');
          checkoutBtn.href = '/login?redirect=/carrinho';
          checkoutBtn.textContent = 'Iniciar Sess√£o para Comprar';
        } else {
          loginNotice.classList.add('hidden');
          checkoutBtn.href = '/checkout';
          checkoutBtn.textContent = 'Finalizar Compra';
        }
      }
    }

    function renderCart() {
      const cartItemsDiv = document.getElementById('cart-items');
      const emptyCartDiv = document.getElementById('empty-cart');
      const subtotalEl = document.getElementById('subtotal');
      const totalEl = document.getElementById('total');
      const checkoutBtn = document.getElementById('checkout-btn');
      
      if (!cartItemsDiv || !emptyCartDiv || !subtotalEl || !totalEl || !checkoutBtn) return;

      const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');

      if (cart.length === 0) {
        cartItemsDiv.innerHTML = '';
        emptyCartDiv.classList.remove('hidden');
        checkoutBtn.classList.add('btn-disabled');
        return;
      }

      emptyCartDiv.classList.add('hidden');
      checkoutBtn.classList.remove('btn-disabled');

      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const deliveryFee = 50;
      const total = subtotal + deliveryFee;

      subtotalEl.textContent = `${subtotal} MT`;
      totalEl.textContent = `${total} MT`;

      cartItemsDiv.innerHTML = cart.map(item => `
        <div class="flex gap-4 p-4 border-b" data-item-id="${item.id}">
          <div class="w-20 h-20 bg-gray-200 rounded flex items-center justify-center text-3xl">
            ${item.category === 'Alimentar' ? 'üåæ' :
              item.category === 'Talho' ? 'ü•©' :
              item.category === 'Congelados' ? '‚ùÑÔ∏è' : 'üßº'}
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-lg">${item.name}</h3>
            <p class="text-sm text-gray-600">${item.category}</p>
            <p class="text-lg font-bold mt-2">${item.price} MT</p>
          </div>
          <div class="flex flex-col items-end justify-between">
            <button class="btn btn-ghost btn-sm btn-circle remove-item" data-id="${item.id}">‚úï</button>
            <div class="flex items-center gap-2">
              <button class="btn btn-sm decrease-qty" data-id="${item.id}">-</button>
              <span class="px-4 font-bold">${item.quantity}</span>
              <button class="btn btn-sm increase-qty" data-id="${item.id}">+</button>
            </div>
            <p class="font-bold text-lg">${item.price * item.quantity} MT</p>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = (e.target as HTMLElement).dataset.id;
          const cart = JSON.parse(localStorage.getItem('cart') || '[]');
          const newCart = cart.filter((item: CartItem) => item.id !== id);
          localStorage.setItem('cart', JSON.stringify(newCart));
          renderCart();
        });
      });

      document.querySelectorAll('.increase-qty').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = (e.target as HTMLElement).dataset.id;
          const cart = JSON.parse(localStorage.getItem('cart') || '[]');
          const item = cart.find((item: CartItem) => item.id === id);
          if (item) {
            item.quantity += 1;
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
          }
        });
      });

      document.querySelectorAll('.decrease-qty').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = (e.target as HTMLElement).dataset.id;
          const cart = JSON.parse(localStorage.getItem('cart') || '[]');
          const item = cart.find((item: CartItem) => item.id === id);
          if (item && item.quantity > 1) {
            item.quantity -= 1;
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      renderCart();
      await updateCheckoutButton();
    });
  </script>
</Layout>
